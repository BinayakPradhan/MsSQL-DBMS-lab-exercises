create database salesman_db
use salesman_db

create table salesmanss(
salesman_id int primary key,
s_name varchar(50),
s_city varchar(50),
commission decimal(8,2));

drop database salesman_db;

insert into salesmanss values
(5001, 'A', 'Ktm', 0.15),
(5002, 'B', 'Ktm', 0.12),
(5003, 'C', 'Pkr', 0.20),
(5004, 'D', 'Pkr', 0.12),
(5005, 'E', 'Chitwan', 0.10),
(5006, 'F', 'Chitwan', 0.15);


create table customers(
customer_id int primary key,
cust_name varchar(50),
city varchar(50),
grade int ,
salesman_id int references salesmanss(salesman_id));

create table orderss (
ord_no int primary key,
purch_amt decimal(8,2),
ord_date varchar(50),
customer_id int references customers(customer_id),
salesman_id int references salesmanss(salesman_id));

insert into customers values
(3002, 'X', 'Ktm', 100, 5001),
(3003, 'Y', 'Ktm', 88, 5001),
(3004, 'Z', 'Pkr', 68, 5002),
(3005, 'W', 'Pkr', 79, 5003),
(3006, 'P', 'Chitwan', 95, 5004),
(3007, 'Q', 'Sanepa', 100, 5004),
(3008, 'R', 'Lalitpur', 39, 5005),
(3009, 'S', 'Patan', 69, 5006),
(3010, 'T', 'Balkhu', 70, 5002),
(3011, 'U', 'Ktm', 99, 5006);


insert into orderss values
(7001, 151.56, '2024-1-05',  3002, 5001),
(7002, 155.56, '2024-2-06',  3003, 5001),
(7003, 140.56, '2024-10-07',  3004, 5002),
(7004, 169.56, '2024-10-08',  3005, 5003),
(7005, 220.20, '2024-10-09',  3006, 5004),
(7006, 400.00, '2024-10-10',  3007, 5004),
(7007, 150.00, '2024-10-11',  3009, 5006),
(7008, 120.00, '2024-10-12',  3008, 5005);

/*lab 5*/
/*Set Operation and Subqueries*/
/*Find all orders generated by those salesperson who live in city 'Ktm'*/
select ord_no, purch_amt, ord_date, customer_id, o.salesman_id from orderss o 
where o.salesman_id in
(select s.salesman_id from salesmanss as s where s_city = 'Ktm');

select * from orderss  
where salesman_id in
(select s.salesman_id from salesmanss as s where s_city = 'Ktm');

/*Find order values greater than average order value of the 2024-10-09*/
select *from orderss o where purch_amt > all(select avg(purch_amt) from orderss where ord_date = '2024-10-09');

/*Count number of customers with grades above average grade of KTM city*/
select grade, count(*) as grade_count from customers group by grade having grade > (select avg(grade) from customers where city = 'Ktm');

/*Find all salesperson & customers who located in 'KTM'*/
select s_name as salesmanandcustomer_names from salesmanss  where s_city = 'Ktm'
union
select cust_name from customers where city = 'Ktm';

/*Find customers whose orders issued on 2024-10-09. Return order detail with customer name*/
select o.* , cust_name from orderss o, customers c where o.customer_id = c.customer_id and ord_date = '2024-10-09';

/*lab 6*/
/*SQL views and queries on multiple tables*/
/*Create a view for those salesperson belong to city 'Pkr'*/
create view salesman_view as
select s_name from salesmanss 
where s_city = 'Pkr';

select *from salesman_view;

/*Create a view to count number of customers in each grade*/
create view customer_view as
select grade, count(*) as grade_cust_count from customers 
group by grade;

select *from customer_view;

/*Create a view to count number of unique customer, compute 
average and total purchase amount of customer orders by each date*/
create view count_viewss as
select ord_date, count(distinct customer_id) as unique_cust_count, avg(purch_amt) as average_purchase, sum(purch_amt) as total_purchase
from orderss group by ord_date;

select *from count_viewss;

/*Find those salesperson who generated orders for their customer but not located in same city*/
select s.* from salesmanss s, customers c, orderss o 
where o.salesman_id = s.salesman_id and c.customer_id = o.customer_id 
and s.s_city <> c.city;

/*Find the customers who served by a salesperson and the salesperson works at commission in the range of 10% to 14%*/
select c.cust_name from customers c, salesmanss s, orderss o 
where s.salesman_id = c.salesman_id 
and o.customer_id = c.customer_id 
and s.commission between 0.10 and 0.14; 



/*Better code*/

--1)find all the orders ,generated by the salesperson who live in city 'ktm'

select distinct o.order_no,o.customer_id,o.ord_date,o.purch_amt,o.salesman_id from orders o ,salesman as s
where s.salesman_id in
(
select s.salesman_id from salesman as s where s.city='ktm'
);

--2)find order values greater than average order value of 10th october 2022

insert into orders values 
(7011, 450.90, '2022-10-10', 3002, 5001),
(7012, 400.90, '2022-10-10', 3006, 5002),
(7013, 250.90, '2022-10-10', 3007, 5001);

select * from orders where
orders.purch_amt > ( select avg(orders.purch_amt) from orders where orders.ord_date='2022-10-10'
);

--3)count number of customer with grades above average grade of ktm city

select customer.cust_grade,count(*) from customer
group by cust_grade having cust_grade> (select avg(cust_grade) from customer where cust_city='ktm');

--4)find all salesperson & customer who located in 'ktm'

select  salesman.name from salesman where salesman.city='ktm'
union
select customer.cust_name from customer where cust_city='ktm'

--5)find customers whose orders issued on 17th Aug 2022. Return orders detail with customer name.

select distinct customer.cust_name, orders.customer_id, orders.ord_date, orders.order_no,
orders.purch_amt, orders.salesman_id from customer, orders where
customer.customer_id = orders.customer_id and
orders.ord_date='2022-10-05';

--lab6
--1) create a view for those salesperson belong to city 'pokhara'
insert into salesman values (5028, 'B', 'pokhara', 0.22);

create view [pokhara salesman] as
select * from salesman where salesman.city in (select salesman.city from salesman where salesman.city='pokhara');

select * from [pokhara salesman]

--2) create a view to count number of customer in each grade

create view [count customer] as
select cust_grade, count(*) as no_of_customer from customer group by cust_grade;

select * from [count customer]

--3)
create view [no3] as
select orders.ord_date,count(distinct orders.customer_id) as no_of_unique, avg(orders.purch_amt) as average, sum(distinct orders.purch_amt) as total from customer ,orders
group by orders.ord_date;
select * from [no3]

drop view [no3]

--4)
select s.salesman_id, s.name, s.city from salesman s, orders o, customer c where
(
s.salesman_id=o.salesman_id and
c.customer_id = o.customer_id and
s.city <> c.cust_city
);

--5)
select c.customer_id, c.cust_name,c.cust_city,c.cust_grade,c.salesman_id , s.salesman_id from customer c, salesman s
where(
s.salesman_id=c.salesman_id and
s.commision between 0.12 and 0.14
);


